name: Terraform Deploy

on:
  push:
    branches:
      - main

  jobs:
    terraform:
      name: Terraform
      runs-on: ubuntu-latest
      permissions:
        contents: read
        id-token: write

      steps:
        - name: Checkout repository
          uses: actions/checkout@v3

        - name: Setup Terraform
          uses: hashicorp/setup-terraform@v2
          with:
            terraform_version: 1.7.5
            cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

        - name: Terraform Init
          run: terraform init

        - name: Terraform Validate
          run: terraform validate

        - name: Terraform Plan
          run: terraform plan -out=tfplan

        - name: Terraform Apply
          if: github.ref == 'refs/heads/main'
          run: terraform apply -auto-approve tfplan